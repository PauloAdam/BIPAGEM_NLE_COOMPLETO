<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Separação de Pedido</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ================= BASE ================= */
body {
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:#e5e7eb;
  width:100%;
  margin:0;
  padding:16px;
}

.container {
  max-width:720px;
  margin:auto;
}

h2 {
  text-align:center;
  font-size:26px;
}

/* ================= INPUTS ================= */
input, button {
  width:100%;
  padding:20px;
  font-size:22px;
  margin-bottom:14px;
  border-radius:12px;
  border:none;
}

input {
  background:#020617;
  color:#fff;
}

button.primary { background:#2563eb; color:white; }
button.success { background:#16a34a; color:white; }
button.warn { background:#ca8a04; color:black; }

button:disabled {
  background:#334155 !important;
  color:#94a3b8;
  cursor:not-allowed;
}

/* ================= ALERTA CENTRAL ================= */
#alerta {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  background:rgba(0,0,0,0.65);
}

#alerta .box {
  background:#020617;
  border:8px solid;
  padding:48px;
  border-radius:26px;
  text-align:center;
  font-size:48px;
  font-weight:bold;
  max-width:92%;
  white-space:pre-line;
}

.alerta-ok    { border-color:#22c55e; color:#22c55e; }
.alerta-erro  { border-color:#ef4444; color:#ef4444; }
.alerta-info  { border-color:#38bdf8; color:#38bdf8; }

/* ================= ITENS ================= */
.item {
  background:#020617;
  padding:18px;
  border-radius:12px;
  margin-bottom:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:20px;
}

.item.done { opacity:0.4; }
.item.active { border:4px solid #38bdf8; }

/* ================= CONTADOR ================= */
.counter {
  font-size:96px;
  text-align:center;
  margin:30px 0;
  font-weight:bold;
}

/* ================= TABLET ================= */
@media (min-width: 768px) {
  .counter { font-size:110px; }
  #alerta .box { font-size:52px; }
}

/* ================= DESKTOP ================= */
@media (min-width: 1024px) {
  .container { max-width:600px; }
}

/* ================= BLING STATUS ================= */
#blingBox {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  margin-bottom:15px;
  font-size:16px;
  font-weight:bold;
}

.dot {
  width:14px;
  height:14px;
  border-radius:50%;
  display:inline-block;
}

.dot.on {
  background:#22c55e;
  box-shadow:0 0 10px #22c55e;
}

.dot.off {
  background:#ef4444;
  box-shadow:0 0 10px #ef4444;
}

/* ================= TELA DE CONFIRMAÇÃO ================= */
#confirmacaoFalta {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.75);
  z-index:99999;
}
#confirmacaoFalta .box {
  background:#0f172a;
  padding:30px;
  border-radius:20px;
  width:90%;
  max-width:420px;
  text-align:center;
  border:6px solid #ca8a04;
}
#confirmacaoFalta h2 {
  color:#facc15;
  margin-bottom:20px;
  font-size:26px;
}
#confirmacaoFalta p {
  font-size:20px;
  margin-bottom:30px;
  white-space:pre-line;
}
#btnConfirmarFalta {
  padding:18px;
  font-size:20px;
  width:100%;
  border-radius:12px;
  background:#16a34a;
  color:#fff;
  margin-bottom:12px;
}
#btnCancelarFalta {
  padding:18px;
  font-size:20px;
  width:100%;
  border-radius:12px;
  background:#ef4444;
  color:#fff;
}
</style>
</head>

<body>
<div class="container">

<h2>Separação de Pedido</h2>

<div id="blingBox">
  <span id="blingDot" class="dot off"></span>
  <span id="blingText">Verificando Bling...</span>
</div>

<input id="pedidoInput" placeholder="Número do pedido">
<button id="btnPedido" class="primary" onclick="carregarPedido()">
  Carregar Pedido
</button>

<hr>

<input id="scanInput" placeholder="Bipe o produto" autofocus>

<div id="ativo"></div>
<div id="lista"></div>

<button id="btnFinalizar" class="success" onclick="finalizarPedido()">
  Finalizar Pedido
</button>

</div>

<!-- ALERTA -->
<div id="alerta">
  <div id="alertaBox" class="box"></div>
</div>

<!-- CONFIRMAÇÃO DE FALTA -->
<div id="confirmacaoFalta">
  <div class="box">
    <h2>Itens Faltando</h2>
    <p id="msgFalta"></p>
    <button id="btnConfirmarFalta">Finalizar Mesmo Assim</button>
    <button id="btnCancelarFalta">Cancelar</button>
  </div>
</div>

<audio id="sndOk" src="success.mp3"></audio>
<audio id="sndErro" src="error.mp3"></audio>

<script>
let pedido = {};
let produtoAtivo = null;
let finalizado = {};
let alertaTimer = null;
let finalizando = false;

const scanInput = document.getElementById("scanInput");
const alerta = document.getElementById("alerta");
const alertaBox = document.getElementById("alertaBox");
const sndOk = document.getElementById("sndOk");
const sndErro = document.getElementById("sndErro");
const btnPedido = document.getElementById("btnPedido");
const pedidoInput = document.getElementById("pedidoInput");
const btnFinalizar = document.getElementById("btnFinalizar");

function focoScan(){ setTimeout(()=>scanInput.focus(),60); }

function status(msg,tipo="info"){
  clearTimeout(alertaTimer);
  alertaBox.textContent=msg;
  alertaBox.className="box alerta-"+tipo;
  alerta.style.display="flex";
  alertaTimer=setTimeout(()=>alerta.style.display="none",3000);
}

/* ================= BLING ================= */
async function verificarBling() {
  try {
    const r = await fetch("/bling/status");
    const d = await r.json();
    const dot = document.getElementById("blingDot");
    const txt = document.getElementById("blingText");

    if (d.conectado) {
      dot.className = "dot on";
      txt.textContent = "Bling conectado";
    } else throw 0;
  } catch {
    document.getElementById("blingDot").className = "dot off";
    document.getElementById("blingText").textContent = "Bling desconectado";
  }
}
verificarBling();
setInterval(verificarBling,30000);

/* ================= PEDIDO ================= */
async function carregarPedido(){
  const num=pedidoInput.value.trim();
  if(!num){status("INFORME O PEDIDO","erro");sndErro.play();return;}

  btnPedido.disabled=true;
  pedidoInput.disabled=true;

  const r=await fetch("/pedido/"+num);
  const d=await r.json();

  if(d.erro){
    status(d.erro,"erro");sndErro.play();
    btnPedido.disabled=false;
    pedidoInput.disabled=false;
    return;
  }

  pedido=d;
  produtoAtivo=null;
  finalizado={};

  status("PEDIDO CARREGADO\nBIPE UM PRODUTO","ok");
  render();
  focoScan();
}

/* ================= SCAN ================= */
scanInput.addEventListener("keydown",async e=>{
  if(e.key!=="Enter")return;

  const codigo=scanInput.value.trim();
  scanInput.value="";

  if(produtoAtivo){
    const c=pedido[produtoAtivo].codigos||[];
    if(!c.includes(codigo)){
      status("TERMINE O ITEM ABERTO","erro");
      sndErro.play();
      return;
    }
  }

  const r=await fetch("/scan",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({codigo})
  });

  const d=await r.json();

  if(d.erro){ status(d.erro,"erro"); sndErro.play(); return; }

  pedido[d.idProduto].bipado=d.bipado;

  if(!produtoAtivo){
    produtoAtivo=d.idProduto;
    status("TERMINE ESTE ITEM","info");
  }

  if(pedido[d.idProduto].bipado===pedido[d.idProduto].pedido){
    finalizado[d.idProduto]=true;
    produtoAtivo=null;
    status("ITEM CONCLUÍDO","ok");
    sndOk.play();
  } else {
    sndOk.play();
  }

  render();
  focoScan();
});

/* ================= FINALIZAR ================= */
const telaFalta = document.getElementById("confirmacaoFalta");
const msgFalta = document.getElementById("msgFalta");
const btnConfirmarFalta = document.getElementById("btnConfirmarFalta");
const btnCancelarFalta = document.getElementById("btnCancelarFalta");

async function finalizarPedido(){
  if(finalizando) return;

  const falt=Object.values(pedido).filter(p=>p.bipado<p.pedido);

  if(falt.length){
    msgFalta.textContent = `Existem ${falt.length} item(ns) faltando.\nDeseja realmente finalizar?`;
    telaFalta.style.display="flex";
    focoScan();
    return;
  }

  executarFinalizacao();
}

btnCancelarFalta.onclick = () => {
  telaFalta.style.display="none";
  status("PEDIDO COM FALTA","erro");
  sndErro.play();
  focoScan();
};

btnConfirmarFalta.onclick = () => {
  telaFalta.style.display="none";

  btnFinalizar.disabled = true;
  btnFinalizar.textContent = "Finalizando...";

  Object.values(pedido).forEach(p => p.bipado = p.pedido);

  executarFinalizacao();
};

async function executarFinalizacao(){
  finalizando=true;
  btnFinalizar.disabled=true;
  btnFinalizar.textContent="Finalizando...";

  try{
    const r=await fetch("/finalizar",{method:"POST"});
    const d=await r.json();

    if(d.ok){
      status(d.aviso ? "✔ ESTOQUE LANÇADO\n"+d.aviso : "✔ PEDIDO FINALIZADO","ok");
      sndOk.play();
      setTimeout(()=>location.reload(),1500);
    } else throw 0;

  } catch {
    status("⚠ ERRO AO FINALIZAR\nVERIFIQUE NO BLING","erro");
    sndErro.play();
    btnFinalizar.disabled=false;
    btnFinalizar.textContent="Finalizar Pedido";
    finalizando=false;
  }
}

/* ================= RENDER ================= */
function render(){
  lista.innerHTML="";
  ativo.innerHTML="";

  if(produtoAtivo){
    const p=pedido[produtoAtivo];

    ativo.innerHTML=`
      <div class="item active"><strong>${p.nome}</strong><span>${p.bipado}/${p.pedido}</span></div>
      <div class="counter">${p.bipado} / ${p.pedido}</div>
      <button class="warn" onclick="acabarItem()">ACABOU NO ESTOQUE</button>
    `;
    return;
  }

  Object.values(pedido).forEach(p=>{
    lista.innerHTML += `
      <div class="item ${p.bipado===p.pedido?"done":""}">
        <span>${p.nome}</span>
        <strong>${p.bipado}/${p.pedido}</strong>
      </div>`;
  });
}

function acabarItem(){
  finalizado[produtoAtivo]=true;
  produtoAtivo=null;
  status("FALTA NO ESTOQUE","erro");
  sndErro.play();
  render();
  focoScan();
}
</script>
</body>
</html>
