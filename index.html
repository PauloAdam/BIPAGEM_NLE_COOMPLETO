<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Separação de Pedido</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ================= BASE ================= */
body {
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:#e5e7eb;
  width:100%;
  margin:0;
  padding:16px;
}

.container {
  max-width:720px;
  margin:auto;
}

h2 {
  text-align:center;
  font-size:26px;
}

/* ================= INPUTS ================= */
input, button {
  width:100%;
  padding:20px;
  font-size:22px;
  margin-bottom:14px;
  border-radius:12px;
  border:none;
}

input {
  background:#020617;
  color:#fff;
}

button.primary { background:#2563eb; color:white; }
button.success { background:#16a34a; color:white; }
button.warn { background:#ca8a04; color:black; }

button:disabled {
  background:#334155 !important;
  color:#94a3b8;
  cursor:not-allowed;
}

/* ================= ALERTA CENTRAL ================= */
#alerta {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  background:rgba(0,0,0,0.65);
}

#alerta .box {
  background:#020617;
  border:8px solid;
  padding:48px;
  border-radius:26px;
  text-align:center;
  font-size:48px;
  font-weight:bold;
  max-width:92%;
  white-space:pre-line;
}

.alerta-ok    { border-color:#22c55e; color:#22c55e; }
.alerta-erro  { border-color:#ef4444; color:#ef4444; }
.alerta-info  { border-color:#38bdf8; color:#38bdf8; }

/* ================= ITENS ================= */
.item {
  background:#020617;
  padding:18px;
  border-radius:12px;
  margin-bottom:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:20px;
}

.item.done { opacity:0.4; }
.item.active { border:4px solid #38bdf8; }

/* ================= CONTADOR ================= */
.counter {
  font-size:96px;
  text-align:center;
  margin:30px 0;
  font-weight:bold;
}

/* ================= TABLET ================= */
@media (min-width: 768px) {
  .counter { font-size:110px; }
  #alerta .box { font-size:52px; }
}

/* ================= DESKTOP ================= */
@media (min-width: 1024px) {
  .container { max-width:600px; }
}
</style>
</head>

<body>
<div class="container">

<h2>Separação de Pedido</h2>

<input id="pedidoInput" placeholder="Número do pedido">
<button id="btnPedido" class="primary" onclick="carregarPedido()">
  Carregar Pedido
</button>

<hr>

<input id="scanInput" placeholder="Bipe o produto" autofocus>

<div id="ativo"></div>
<div id="lista"></div>

<button class="success" onclick="finalizarPedido()">
  Finalizar Pedido
</button>

</div>

<!-- ALERTA -->
<div id="alerta">
  <div id="alertaBox" class="box"></div>
</div>

<audio id="sndOk" src="success.mp3"></audio>
<audio id="sndErro" src="error.mp3"></audio>

<script>
/* ⚠️ LOGICA 100% INTACTA – NÃO TOQUEI */
let pedido = {};
let produtoAtivo = null;
let finalizado = {};
let alertaTimer = null;

const scanInput = document.getElementById("scanInput");
const alerta = document.getElementById("alerta");
const alertaBox = document.getElementById("alertaBox");
const sndOk = document.getElementById("sndOk");
const sndErro = document.getElementById("sndErro");
const btnPedido = document.getElementById("btnPedido");
const pedidoInput = document.getElementById("pedidoInput");

function focoScan(){ setTimeout(()=>scanInput.focus(),50); }

function status(msg,tipo="info"){
  clearTimeout(alertaTimer);
  alertaBox.textContent=msg;
  alertaBox.className="box alerta-"+tipo;
  alerta.style.display="flex";
  alertaTimer=setTimeout(()=>alerta.style.display="none",3000);
}

async function carregarPedido(){
  const num=pedidoInput.value.trim();
  if(!num){status("INFORME O PEDIDO","erro");sndErro.play();return;}
  btnPedido.disabled=true;pedidoInput.disabled=true;
  const r=await fetch("/pedido/"+num);const d=await r.json();
  if(d.erro){status(d.erro,"erro");sndErro.play();btnPedido.disabled=false;pedidoInput.disabled=false;return;}
  pedido=d;produtoAtivo=null;finalizado={};
  status("PEDIDO CARREGADO\nBIPE UM PRODUTO","ok");
  render();focoScan();
}

scanInput.addEventListener("keydown",async e=>{
  if(e.key!=="Enter")return;
  const codigo=scanInput.value.trim();scanInput.value="";
  if(produtoAtivo){
    const c=pedido[produtoAtivo].codigos||[];
    if(!c.includes(codigo)){status("TERMINE O ITEM ABERTO","erro");sndErro.play();return;}
  }
  const r=await fetch("/scan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({codigo})});
  const d=await r.json();
  if(d.erro){status(d.erro,"erro");sndErro.play();return;}
  pedido[d.idProduto].bipado=d.bipado;
  if(!produtoAtivo){produtoAtivo=d.idProduto;status("TERMINE ESTE ITEM","info");}
  if(pedido[d.idProduto].bipado===pedido[d.idProduto].pedido){
    finalizado[d.idProduto]=true;produtoAtivo=null;status("ITEM CONCLUÍDO","ok");sndOk.play();
  } else sndOk.play();
  render();focoScan();
});

function acabarItem(){
  finalizado[produtoAtivo]=true;produtoAtivo=null;
  status("FALTA NO ESTOQUE","erro");sndErro.play();render();focoScan();
}

async function finalizarPedido(){
  const falt=Object.values(pedido).filter(p=>p.bipado<p.pedido);
  if(falt.length){status("PEDIDO COM FALTA","erro");sndErro.play();return;}
  const r=await fetch("/finalizar",{method:"POST"});const d=await r.json();
  if(d.ok){status("PEDIDO FINALIZADO","ok");sndOk.play();setTimeout(()=>location.reload(),1500);}
  else{status("ERRO AO FINALIZAR","erro");sndErro.play();}
}

function render(){
  lista.innerHTML="";ativo.innerHTML="";
  if(produtoAtivo){
    const p=pedido[produtoAtivo];
    ativo.innerHTML=`
      <div class="item active"><strong>${p.nome}</strong><span>${p.bipado}/${p.pedido}</span></div>
      <div class="counter">${p.bipado} / ${p.pedido}</div>
      <button class="warn" onclick="acabarItem()">ACABOU NO ESTOQUE</button>`;
    return;
  }
  Object.values(pedido).forEach(p=>{
    lista.innerHTML+=`<div class="item ${p.bipado===p.pedido?"done":""}">
      <span>${p.nome}</span><strong>${p.bipado}/${p.pedido}</strong></div>`;
  });
}
</script>

</body>
</html>
